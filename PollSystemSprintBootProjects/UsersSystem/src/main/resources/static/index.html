<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מערכת סקרים</title>
    <link href="https://fonts.googleapis.com/css2?family=Alef&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Alef', sans-serif; background: #f4f7fa; margin: 0; padding: 0; }
        .container { width: 90%; max-width: 900px; margin: 80px auto 20px auto; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }

        #message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 6px;
            display: none;
            z-index: 9999;
            font-weight: bold;
        }
        #message.success { background: #d4edda; color: #155724; }
        #message.error { background: #f8d7da; color: #721c24; }

        .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-radius: 8px 8px 0 0; background: #ddd; margin: 0 5px; transition: 0.3s; }
        .tab.active { background: #4CAF50; color: white; }

        .tab-content { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); display: none; }
        .tab-content.active { display: block; }

        input, select, button { padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; }
        input { width: calc(100% - 20px); }
        button { background: #4CAF50; color: white; border: none; cursor: pointer; transition: 0.3s; }
        button:hover { background: #45a049; }

        .card { background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        .radio-group { margin: 8px 0; }
        .radio-group label { margin-right: 15px; }
        .user-list, .question-list { display: flex; flex-direction: column; }
        .user button, .question button { float: left; background: #2196F3; margin-top: 10px; }
        .user button:hover, .question button:hover { background: #0b7dda; }
        .selected-user { font-weight: bold; color: #2196F3; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="message"></div>

<div class="container">
    <h1>מערכת הסקרים של אופיר</h1>

    <div class="tabs">
        <div class="tab active" data-tab="createUserTab">צור משתמש</div>
        <div class="tab" data-tab="loginTab">התחברות</div>
        <div class="tab" data-tab="answerTab">ענה על שאלה</div>
    </div>

    <div id="createUserTab" class="tab-content active">
        <div class="card">
            <input type="text" id="firstName" placeholder="שם פרטי">
            <input type="text" id="lastName" placeholder="שם משפחה">
            <input type="email" id="email" placeholder="אימייל">
            <input type="number" id="age" placeholder="גיל">
            <input type="text" id="address" placeholder="כתובת">
            <button onclick="createUser()">צור משתמש</button>
        </div>
    </div>

    <div id="loginTab" class="tab-content">
        <div class="card">
            <input type="email" id="loginEmail" placeholder="אימייל להתחברות">
            <button onclick="loginUser()">התחבר</button>
        </div>
    </div>

    <div id="answerTab" class="tab-content">
        <div class="selected-user" id="selectedUser">משתמש לא מחובר</div>
        <div class="question-list" id="questionList"></div>
    </div>
</div>

<script>
    const messageEl = document.getElementById('message');
    let selectedUserId = null;
    let selectedUserName = '';

    function showMessage(text, type='success') {
        messageEl.textContent = text;
        messageEl.className = type === 'success' ? 'success' : 'error';
        messageEl.style.display = 'block';
        setTimeout(() => messageEl.style.display = 'none', 4000);
    }

    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.getAttribute('data-tab');
            contents.forEach(c => c.classList.remove('active'));
            document.getElementById(target).classList.add('active');
        });
    });

    // Users
    async function fetchUsers() {
        const res = await fetch('/users');
        return await res.json();
    }

    async function createUser() {
        const firstName = document.getElementById('firstName').value;
        const lastName = document.getElementById('lastName').value;
        const email = document.getElementById('email').value;
        const age = parseInt(document.getElementById('age').value);
        const address = document.getElementById('address').value;

        const res = await fetch('/users', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({firstName,lastName,email,age,address})
        });
        if(res.ok){
            showMessage('משתמש נוצר בהצלחה','success');
        } else {
            const err = await res.text();
            showMessage('שגיאה ביצירת המשתמש', 'error');
        }
    }

    // Login by email
    async function loginUser() {
        const email = document.getElementById('loginEmail').value;
        const users = await fetchUsers();
        const user = users.find(u => u.email === email);
        if(user){
            selectedUserId = user.id;
            selectedUserName = user.firstName + ' ' + user.lastName;
            document.getElementById('selectedUser').textContent = `מחובר בתור : ${selectedUserName}`;
            showMessage('התחברת בהצלחה', 'success');
            document.querySelector('.tab[data-tab="answerTab"]').click();
        } else {
            showMessage('משתמש לא קיים', 'error');
        }
    }

    // Polls
    async function fetchQuestions() {
        const res = await fetch('http://localhost:8080/questions');
        const questions = await res.json();
        const container = document.getElementById('questionList');
        container.innerHTML = '';
        questions.forEach(q => {
            const div = document.createElement('div');
            div.className = 'card question';
            div.innerHTML = `<b>${q.title}</b><br>`;
            for(let i=1;i<=4;i++){
                div.innerHTML += `
                    <div class="radio-group">
                        <input type="radio" name="q${q.id}" value="${i}" id="q${q.id}o${i}">
                        <label for="q${q.id}o${i}">${q['option'+i]}</label>
                    </div>
                `;
            }
            div.innerHTML += `<button onclick="submitAnswer(${q.id})">שלח תשובה</button>`;
            container.appendChild(div);
        });
    }

    async function submitAnswer(questionId) {
        if(!selectedUserId){
            showMessage('בצע התחברות לפני שליחת תשובה', 'error');
            return;
        }
        const radios = document.getElementsByName('q'+questionId);
        let selectedOption = null;
        for(const r of radios){
            if(r.checked){
                selectedOption = parseInt(r.value);
                break;
            }
        }
        if(!selectedOption){
            showMessage('בחר תשובה לפני שליחה', 'error');
            return;
        }

        const res = await fetch('http://localhost:8080/answers', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({userId:selectedUserId, questionId, selectedOption})
        });
        if(res.ok){
            showMessage('תשובה נשלחה בהצלחה', 'success');
        } else {
            const err = await res.text();
            showMessage('שגיאה בשליחת התשובה', 'error');
        }
    }

    fetchQuestions();
</script>
</body>
</html>
